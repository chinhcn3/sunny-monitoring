# GitHub Actions Workflow cho Health Check
# 
# Äá»ƒ cháº¡y health check má»—i 10 phÃºt, workflow nÃ y sá»­ dá»¥ng schedule trigger
# Cron patterns phá»• biáº¿n:
# - Má»—i 10 phÃºt: */10 * * * *
# - Má»—i 15 phÃºt: */15 * * * *
# - Má»—i giá»: 0 * * * *
# - Má»—i 6 giá»: 0 */6 * * *
#
# Cáº¥u hÃ¬nh biáº¿n trong GitHub:
# Settings > Secrets and variables > Actions > Variables:
#   - HEALTH_CHECK_API_URL: https://tdffm.com
#   - TELEGRAM_BOT_TOKEN: (náº¿u muá»‘n nháº­n thÃ´ng bÃ¡o)
#   - TELEGRAM_CHAT_ID: (náº¿u muá»‘n nháº­n thÃ´ng bÃ¡o)

name: Health Check

on:
  # Cháº¡y theo lá»‹ch (má»—i 10 phÃºt)
  schedule:
    - cron: '*/10 * * * *'
  
  # Cháº¡y thá»§ cÃ´ng tá»« GitHub UI
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL Ä‘á»ƒ health check'
        required: false
        type: string
  
  # Cháº¡y khi push code
  push:
    branches:
      - main
      - master
  
  # Cháº¡y khi cÃ³ pull request
  pull_request:
    branches:
      - main
      - master

env:
  # CÃ¡c biáº¿n máº·c Ä‘á»‹nh - cÃ³ thá»ƒ override báº±ng GitHub Secrets/Variables
  HEALTH_CHECK_TIMEOUT: 30
  HEALTH_CHECK_RETRIES: 3

jobs:
  health-check:
    name: Health Check API
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup job info
        id: job-info
        run: |
          echo "=========================================="
          echo "ðŸš€ HEALTH CHECK JOB ÄÃƒ ÄÆ¯á»¢C Gá»ŒI!"
          echo "=========================================="
          echo "ðŸ“‹ Workflow: ${GITHUB_WORKFLOW}"
          echo "ðŸŒ¿ Branch: ${GITHUB_REF_NAME}"
          echo "ðŸ†” Run ID: ${GITHUB_RUN_ID}"
          echo "ðŸ• Thá»i gian: $(date)"
          echo "=========================================="
      
      - name: Health Check API
        id: health-check
        env:
          API_URL: ${{ github.event.inputs.api_url || vars.HEALTH_CHECK_API_URL || secrets.HEALTH_CHECK_API_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ” Báº¯t Ä‘áº§u health check cho API..."
          
          # Kiá»ƒm tra xem API_URL Ä‘Ã£ Ä‘Æ°á»£c set chÆ°a
          if [ -z "${API_URL}" ]; then
            echo "âŒ Lá»—i: HEALTH_CHECK_API_URL chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh!"
            echo "Vui lÃ²ng thÃªm biáº¿n HEALTH_CHECK_API_URL trong GitHub Secrets/Variables"
            echo "Hoáº·c truyá»n qua workflow_dispatch input"
            exit 1
          fi
          
          HEALTH_CHECK_ENDPOINT="${API_URL}/api/v1/health"
          echo "ðŸŒ API URL: ${API_URL}"
          echo "ðŸ”— Health Check Endpoint: ${HEALTH_CHECK_ENDPOINT}"
          
          # Debug: Kiá»ƒm tra cÃ¡c biáº¿n Telegram (khÃ´ng hiá»ƒn thá»‹ giÃ¡ trá»‹ Ä‘á»ƒ báº£o máº­t)
          if [ -n "${TELEGRAM_BOT_TOKEN}" ]; then
            echo "âœ… TELEGRAM_BOT_TOKEN: Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh"
          else
            echo "â„¹ï¸  TELEGRAM_BOT_TOKEN: chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh (sáº½ khÃ´ng gá»­i thÃ´ng bÃ¡o Telegram)"
          fi
          
          if [ -n "${TELEGRAM_CHAT_ID}" ]; then
            echo "âœ… TELEGRAM_CHAT_ID: Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh"
          else
            echo "â„¹ï¸  TELEGRAM_CHAT_ID: chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh (sáº½ khÃ´ng gá»­i thÃ´ng bÃ¡o Telegram)"
          fi
          
          # Thá»±c hiá»‡n health check vá»›i retry logic
          MAX_RETRIES=${HEALTH_CHECK_RETRIES:-3}
          RETRY_COUNT=0
          SUCCESS=false
          HTTP_CODE="000"
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ðŸ”„ Láº§n thá»­: $((RETRY_COUNT + 1))/$MAX_RETRIES"
            
            # Thá»±c hiá»‡n curl request
            HTTP_CODE=$(curl -s -o /tmp/health_response.json -w "%{http_code}" \
              --max-time ${HEALTH_CHECK_TIMEOUT:-30} \
              --connect-timeout 10 \
              -H "Accept: application/json" \
              "${HEALTH_CHECK_ENDPOINT}" || echo "000")
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "âœ… Health check thÃ nh cÃ´ng!"
              echo "Response:"
              if command -v jq &> /dev/null; then
                cat /tmp/health_response.json | jq '.' 2>/dev/null || cat /tmp/health_response.json | head -50
                # TrÃ­ch xuáº¥t thÃ´ng tin tá»« response
                COMMIT_HASH=$(cat /tmp/health_response.json | jq -r '.data.info.commitHash // .data.details.commitHash // "N/A"' 2>/dev/null)
                BUILD_DATE=$(cat /tmp/health_response.json | jq -r '.data.info.buildDate // .data.details.buildDate // "N/A"' 2>/dev/null)
                if [ "$COMMIT_HASH" != "N/A" ] || [ "$BUILD_DATE" != "N/A" ]; then
                  echo ""
                  echo "ðŸ“¦ ThÃ´ng tin build:"
                  echo "   Commit: ${COMMIT_HASH}"
                  echo "   Build Date: ${BUILD_DATE}"
                fi
              else
                cat /tmp/health_response.json | head -50
              fi
              SUCCESS=true
              
              # Gá»­i thÃ´ng bÃ¡o Telegram khi thÃ nh cÃ´ng
              if [ -n "${TELEGRAM_BOT_TOKEN}" ] && [ -n "${TELEGRAM_CHAT_ID}" ]; then
                echo "ðŸ“± Äang gá»­i thÃ´ng bÃ¡o Telegram..."
                TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
                WORKFLOW_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
                
                # TrÃ­ch xuáº¥t thÃ´ng tin tá»« response Ä‘á»ƒ thÃªm vÃ o message
                if command -v jq &> /dev/null && [ -f /tmp/health_response.json ]; then
                  COMMIT_HASH=$(cat /tmp/health_response.json | jq -r '.data.info.commitHash // .data.details.commitHash // ""' 2>/dev/null)
                  BUILD_DATE=$(cat /tmp/health_response.json | jq -r '.data.info.buildDate // .data.details.buildDate // ""' 2>/dev/null)
                else
                  COMMIT_HASH=""
                  BUILD_DATE=""
                fi
                
                MESSAGE="âœ… Health Check ThÃ nh CÃ´ng%0A%0A"
                MESSAGE="${MESSAGE}ðŸ• Thá»i gian: ${TIMESTAMP}%0A"
                MESSAGE="${MESSAGE}ðŸŒ API: ${API_URL}%0A"
                MESSAGE="${MESSAGE}ðŸ“Š Status: HTTP ${HTTP_CODE}%0A"
                if [ -n "$COMMIT_HASH" ]; then
                  MESSAGE="${MESSAGE}ðŸ“¦ Commit: ${COMMIT_HASH}%0A"
                fi
                if [ -n "$BUILD_DATE" ]; then
                  MESSAGE="${MESSAGE}ðŸ—ï¸  Build: ${BUILD_DATE}%0A"
                fi
                MESSAGE="${MESSAGE}ðŸ”„ Láº§n thá»­: $((RETRY_COUNT + 1))/${MAX_RETRIES}%0A"
                MESSAGE="${MESSAGE}ðŸ”— Workflow: ${WORKFLOW_URL}"
                
                TELEGRAM_URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${MESSAGE}"
                
                # Gá»­i Telegram vá»›i retry logic
                TELEGRAM_RETRY=0
                TELEGRAM_MAX_RETRY=3
                TELEGRAM_SUCCESS=false
                
                while [ $TELEGRAM_RETRY -lt $TELEGRAM_MAX_RETRY ]; do
                  TELEGRAM_RETRY=$((TELEGRAM_RETRY + 1))
                  echo "  ðŸ”„ Gá»­i Telegram láº§n $TELEGRAM_RETRY/$TELEGRAM_MAX_RETRY..."
                  
                  # Sá»­ dá»¥ng curl vá»›i timeout vÃ  lÆ°u response vÃ o file táº¡m
                  TELEGRAM_HTTP_CODE=$(curl -s -o /tmp/telegram_response.json -w "%{http_code}" \
                    --max-time 10 \
                    --connect-timeout 5 \
                    "$TELEGRAM_URL" 2>/dev/null || echo "000")
                  
                  if [ "$TELEGRAM_HTTP_CODE" -eq 200 ]; then
                    echo "ðŸ“± ÄÃ£ gá»­i thÃ´ng bÃ¡o Telegram thÃ nh cÃ´ng!"
                    TELEGRAM_SUCCESS=true
                    break
                  else
                    echo "  âš ï¸  Lá»—i gá»­i Telegram (HTTP $TELEGRAM_HTTP_CODE)"
                    if [ -f /tmp/telegram_response.json ]; then
                      echo "  Response: $(cat /tmp/telegram_response.json | head -100)"
                    fi
                    if [ $TELEGRAM_RETRY -lt $TELEGRAM_MAX_RETRY ]; then
                      echo "  â³ Äá»£i 2 giÃ¢y trÆ°á»›c khi thá»­ láº¡i..."
                      sleep 2
                    fi
                  fi
                done
                
                if [ "$TELEGRAM_SUCCESS" = false ]; then
                  echo "âš ï¸  KhÃ´ng thá»ƒ gá»­i thÃ´ng bÃ¡o Telegram sau $TELEGRAM_MAX_RETRY láº§n thá»­"
                  echo "   Kiá»ƒm tra láº¡i TELEGRAM_BOT_TOKEN vÃ  TELEGRAM_CHAT_ID"
                fi
                
                # Cleanup
                rm -f /tmp/telegram_response.json 2>/dev/null || true
              else
                echo "â„¹ï¸  Telegram bot token hoáº·c chat_id chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh, bá» qua gá»­i thÃ´ng bÃ¡o"
              fi
              
              break
            else
              echo "âš ï¸  Health check tháº¥t báº¡i vá»›i HTTP code: $HTTP_CODE"
              if [ -f /tmp/health_response.json ]; then
                echo "Response:"
                cat /tmp/health_response.json
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ Äá»£i 5 giÃ¢y trÆ°á»›c khi thá»­ láº¡i..."
                sleep 5
              fi
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ Health check tháº¥t báº¡i sau $MAX_RETRIES láº§n thá»­!"
            
            # Gá»­i thÃ´ng bÃ¡o Telegram khi tháº¥t báº¡i
            if [ -n "${TELEGRAM_BOT_TOKEN}" ] && [ -n "${TELEGRAM_CHAT_ID}" ]; then
              echo "ðŸ“± Äang gá»­i thÃ´ng bÃ¡o Telegram (tháº¥t báº¡i)..."
              TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
              WORKFLOW_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
              
              MESSAGE="âŒ Health Check Tháº¥t Báº¡i%0A%0A"
              MESSAGE="${MESSAGE}ðŸ• Thá»i gian: ${TIMESTAMP}%0A"
              MESSAGE="${MESSAGE}ðŸŒ API: ${API_URL}%0A"
              MESSAGE="${MESSAGE}âš ï¸  ÄÃ£ thá»­: ${MAX_RETRIES} láº§n%0A"
              MESSAGE="${MESSAGE}ðŸ”— Workflow: ${WORKFLOW_URL}%0A"
              
              TELEGRAM_URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${MESSAGE}"
              
              # Gá»­i vá»›i retry
              TELEGRAM_RETRY=0
              while [ $TELEGRAM_RETRY -lt 3 ]; do
                TELEGRAM_HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                  --max-time 10 \
                  --connect-timeout 5 \
                  "$TELEGRAM_URL" 2>/dev/null || echo "000")
                
                if [ "$TELEGRAM_HTTP_CODE" -eq 200 ]; then
                  echo "ðŸ“± ÄÃ£ gá»­i thÃ´ng bÃ¡o Telegram thÃ nh cÃ´ng!"
                  break
                else
                  TELEGRAM_RETRY=$((TELEGRAM_RETRY + 1))
                  if [ $TELEGRAM_RETRY -lt 3 ]; then
                    sleep 2
                  fi
                fi
              done
            fi
            
            exit 1
          fi
      
      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: health-check-response
          path: /tmp/health_response.json
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/health_response.json 2>/dev/null || true
