# GitHub Actions Workflow cho Health Check
# 
# Äá»ƒ cháº¡y health check má»—i 10 phÃºt, workflow nÃ y sá»­ dá»¥ng schedule trigger
# Cron patterns phá»• biáº¿n:
# - Má»—i 10 phÃºt: */10 * * * *
# - Má»—i 15 phÃºt: */15 * * * *
# - Má»—i giá»: 0 * * * *
# - Má»—i 6 giá»: 0 */6 * * *
#
# Cáº¥u hÃ¬nh secrets trong GitHub:
# Settings > Secrets and variables > Actions > Secrets:
#   - HEALTH_CHECK_API_URL: https://tdffm.com (API URL 1)
#   - HEALTH_CHECK_API_URL_US: https://tdffm-us.com (API URL 2)
#   - TELEGRAM_BOT_TOKEN: (náº¿u muá»‘n nháº­n thÃ´ng bÃ¡o)
#   - TELEGRAM_CHAT_ID: (náº¿u muá»‘n nháº­n thÃ´ng bÃ¡o)

name: Health Check

on:
  # Cháº¡y theo lá»‹ch (má»—i 10 phÃºt)
  schedule:
    - cron: '*/10 * * * *'
  
  # Cháº¡y thá»§ cÃ´ng tá»« GitHub UI
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL Ä‘á»ƒ health check'
        required: false
        type: string
  
  # Cháº¡y khi push code
  push:
    branches:
      - main
      - master
  
  # Cháº¡y khi cÃ³ pull request
  pull_request:
    branches:
      - main
      - master

env:
  # CÃ¡c biáº¿n máº·c Ä‘á»‹nh - cÃ³ thá»ƒ override báº±ng GitHub Secrets/Variables
  HEALTH_CHECK_TIMEOUT: 30
  HEALTH_CHECK_RETRIES: 3

jobs:
  health-check:
    name: Health Check API
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup job info
        id: job-info
        run: |
          echo "=========================================="
          echo "ðŸš€ HEALTH CHECK JOB ÄÃƒ ÄÆ¯á»¢C Gá»ŒI!"
          echo "=========================================="
          echo "ðŸ“‹ Workflow: ${GITHUB_WORKFLOW}"
          echo "ðŸŒ¿ Branch: ${GITHUB_REF_NAME}"
          echo "ðŸ†” Run ID: ${GITHUB_RUN_ID}"
          echo "ðŸ• Thá»i gian: $(date)"
          echo "=========================================="
      
      - name: Health Check API
        id: health-check
        env:
          API_URL_1: ${{ github.event.inputs.api_url || secrets.HEALTH_CHECK_API_URL }}
          API_URL_2: ${{ secrets.HEALTH_CHECK_API_URL_US }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ” Báº¯t Ä‘áº§u health check cho API..."
          
          # Kiá»ƒm tra xem API_URL_1 Ä‘Ã£ Ä‘Æ°á»£c set chÆ°a
          if [ -z "${API_URL_1}" ]; then
            echo "âŒ Lá»—i: HEALTH_CHECK_API_URL chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh!"
            echo "Vui lÃ²ng thÃªm secret HEALTH_CHECK_API_URL trong GitHub Secrets"
            exit 1
          fi
          
          # Kiá»ƒm tra xem API_URL_2 Ä‘Ã£ Ä‘Æ°á»£c set chÆ°a
          if [ -z "${API_URL_2}" ]; then
            echo "âŒ Lá»—i: HEALTH_CHECK_API_URL_US chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh!"
            echo "Vui lÃ²ng thÃªm secret HEALTH_CHECK_API_URL_US trong GitHub Secrets"
            exit 1
          fi
          
          HEALTH_CHECK_ENDPOINT_1="${API_URL_1}/api/v1/health"
          HEALTH_CHECK_ENDPOINT_2="${API_URL_2}/api/v1/health"
          echo "ðŸŒ API URL 1: ${API_URL_1}"
          echo "ðŸŒ API URL 2: ${API_URL_2}"
          echo "ðŸ”— Health Check Endpoint 1: ${HEALTH_CHECK_ENDPOINT_1}"
          echo "ðŸ”— Health Check Endpoint 2: ${HEALTH_CHECK_ENDPOINT_2}"
          
          # Debug: Kiá»ƒm tra cÃ¡c biáº¿n Telegram (khÃ´ng hiá»ƒn thá»‹ giÃ¡ trá»‹ Ä‘á»ƒ báº£o máº­t)
          if [ -n "${TELEGRAM_BOT_TOKEN}" ]; then
            echo "âœ… TELEGRAM_BOT_TOKEN: Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh"
          else
            echo "â„¹ï¸  TELEGRAM_BOT_TOKEN: chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh (sáº½ khÃ´ng gá»­i thÃ´ng bÃ¡o Telegram)"
          fi
          
          if [ -n "${TELEGRAM_CHAT_ID}" ]; then
            echo "âœ… TELEGRAM_CHAT_ID: Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh"
          else
            echo "â„¹ï¸  TELEGRAM_CHAT_ID: chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh (sáº½ khÃ´ng gá»­i thÃ´ng bÃ¡o Telegram)"
          fi
          
          # Function Ä‘á»ƒ check má»™t endpoint
          check_endpoint() {
            local endpoint=$1
            local endpoint_name=$2
            local max_retries=${HEALTH_CHECK_RETRIES:-3}
            local retry_count=0
            local success=false
            local http_code="000"
            
            echo ""
            echo "ðŸ” Checking ${endpoint_name}..."
            
            while [ $retry_count -lt $max_retries ]; do
              echo "ðŸ”„ Láº§n thá»­ ${endpoint_name}: $((retry_count + 1))/$max_retries"
              
              http_code=$(curl -s -o /tmp/health_response_${endpoint_name}.json -w "%{http_code}" \
                --max-time ${HEALTH_CHECK_TIMEOUT:-30} \
                --connect-timeout 10 \
                -H "Accept: application/json" \
                "${endpoint}" || echo "000")
              
              if [ "$http_code" -eq 200 ]; then
                echo "âœ… ${endpoint_name} thÃ nh cÃ´ng!"
                if command -v jq &> /dev/null; then
                  cat /tmp/health_response_${endpoint_name}.json | jq '.' 2>/dev/null | head -20 || cat /tmp/health_response_${endpoint_name}.json | head -20
                else
                  cat /tmp/health_response_${endpoint_name}.json | head -20
                fi
                success=true
                break
              else
                echo "âš ï¸  ${endpoint_name} tháº¥t báº¡i vá»›i HTTP code: $http_code"
                if [ -f /tmp/health_response_${endpoint_name}.json ]; then
                  echo "Response:"
                  cat /tmp/health_response_${endpoint_name}.json | head -20
                fi
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "â³ Äá»£i 5 giÃ¢y trÆ°á»›c khi thá»­ láº¡i..."
                  sleep 5
                fi
              fi
            done
            
            if [ "$success" = false ]; then
              echo "âŒ ${endpoint_name} tháº¥t báº¡i sau $max_retries láº§n thá»­!"
              return 1
            fi
            return 0
          }
          
          # Check cáº£ 2 endpoints
          SUCCESS_1=false
          SUCCESS_2=false
          FAILED_ENDPOINTS=""
          
          if check_endpoint "${HEALTH_CHECK_ENDPOINT_1}" "Endpoint1"; then
            SUCCESS_1=true
          else
            FAILED_ENDPOINTS="${FAILED_ENDPOINTS}${HEALTH_CHECK_ENDPOINT_1} "
          fi
          
          if check_endpoint "${HEALTH_CHECK_ENDPOINT_2}" "Endpoint2"; then
            SUCCESS_2=true
          else
            FAILED_ENDPOINTS="${FAILED_ENDPOINTS}${HEALTH_CHECK_ENDPOINT_2} "
          fi
          
          # Kiá»ƒm tra káº¿t quáº£ tá»•ng thá»ƒ
          if [ "$SUCCESS_1" = true ] && [ "$SUCCESS_2" = true ]; then
            echo ""
            echo "âœ… Táº¥t cáº£ health checks thÃ nh cÃ´ng!"
            exit 0
          else
            echo ""
            echo "âŒ Health check tháº¥t báº¡i!"
            echo "Failed endpoints: ${FAILED_ENDPOINTS}"
            
            # Gá»­i thÃ´ng bÃ¡o Telegram khi tháº¥t báº¡i
            if [ -n "${TELEGRAM_BOT_TOKEN}" ] && [ -n "${TELEGRAM_CHAT_ID}" ]; then
              echo "ðŸ“± Äang gá»­i thÃ´ng bÃ¡o Telegram (tháº¥t báº¡i)..."
              
              MESSAGE="Health Check That Bai"$'\n'"Failed: ${FAILED_ENDPOINTS}"$'\n'"Time: $(date -u)"
              
              # Gá»­i Telegram vá»›i POST vÃ  --data-urlencode (tá»± Ä‘á»™ng encode)
              TELEGRAM_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
                --data-urlencode "text=${MESSAGE}" \
                --max-time 10 \
                --connect-timeout 5)
              
              TELEGRAM_HTTP_CODE=$(echo "$TELEGRAM_RESPONSE" | tail -n1)
              if [ "$TELEGRAM_HTTP_CODE" = "200" ]; then
                echo "ðŸ“± ÄÃ£ gá»­i thÃ´ng bÃ¡o Telegram thÃ nh cÃ´ng!"
              else
                echo "âš ï¸  KhÃ´ng thá»ƒ gá»­i thÃ´ng bÃ¡o Telegram (HTTP $TELEGRAM_HTTP_CODE)"
              fi
            fi
            
            exit 1
          fi
      
      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: health-check-response
          path: |
            /tmp/health_response_*.json
          retention-days: 1
      
      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/health_response_*.json 2>/dev/null || true
