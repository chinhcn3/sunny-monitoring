name: Health Check

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL for health check'
        required: false
        type: string

env:
  HEALTH_CHECK_TIMEOUT: 30
  HEALTH_CHECK_RETRIES: 3

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - uses: actions/checkout@v4

      - name: Health check API
        env:
          API_URL: ${{ github.event.inputs.api_url || vars.HEALTH_CHECK_API_URL || secrets.HEALTH_CHECK_API_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$API_URL" ]; then
            echo "ERROR: HEALTH_CHECK_API_URL not set"
            exit 1
          fi

          ENDPOINT="${API_URL}/api/v1/health"
          MAX_RETRIES=${HEALTH_CHECK_RETRIES}
          TIMEOUT=${HEALTH_CHECK_TIMEOUT}

          echo "Starting health check for: $ENDPOINT"
          echo "Max retries: $MAX_RETRIES, Timeout: ${TIMEOUT}s"

          RETRY=0
          SUCCESS=false

          while [ $RETRY -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY + 1))/$MAX_RETRIES..."
            
            HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
              --max-time $TIMEOUT \
              --connect-timeout 10 \
              "$ENDPOINT" || echo "000")

            echo "HTTP Status: $HTTP_CODE"

            if [ "$HTTP_CODE" = "200" ]; then
              SUCCESS=true
              echo "Health check successful!"
              break
            fi

            RETRY=$((RETRY + 1))
            if [ $RETRY -lt $MAX_RETRIES ]; then
              echo "Waiting 5 seconds before retry..."
              sleep 5
            fi
          done

          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            if [ "$SUCCESS" != "true" ]; then
              MESSAGE="Health check FAILED
API: $API_URL
Time: $(date -u)"
            else
              MESSAGE="Health check OK
API: $API_URL
Time: $(date -u)"
            fi

            # Gửi Telegram với proper encoding
            TELEGRAM_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}")

            TELEGRAM_HTTP_CODE=$(echo "$TELEGRAM_RESPONSE" | tail -n1)
            if [ "$TELEGRAM_HTTP_CODE" = "200" ]; then
              echo "Telegram notification sent successfully"
            else
              echo "Failed to send Telegram notification (HTTP $TELEGRAM_HTTP_CODE)"
              echo "Response: $(echo "$TELEGRAM_RESPONSE" | head -n-1)"
            fi
          fi

          # Cleanup
          rm -f response.json 2>/dev/null || true

          if [ "$SUCCESS" != "true" ]; then
            echo "Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi